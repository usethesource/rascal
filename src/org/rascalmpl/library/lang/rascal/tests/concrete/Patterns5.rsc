module lang::rascal::tests::concrete::Patterns5

syntax ConcreteHole = ;

import ParseTree;

Tree tree_reg1 = appl(regular(\iter-star(\char-class([range(48,57)]))),[]);

bool matchAppl(Tree v:appl(Production p, list[Tree] args)) = true;

test bool matchApplRegular1() = matchAppl(tree_reg1);

Tree  tree_reg2 = appl(regular(\iter-star(\char-class([range(48,57)]))),[appl(regular(\iter-star(lex("LAYOUT"))),[])]);

test bool visitApplRegular() = /appl(_, [_]) := tree_reg2;

test bool matchApplRegular2()  = appl(_, [_]) !:= appl(regular(\iter-star(lex("LAYOUT"))),[]);

// A concrete pattern for EXP with two EXP holes
Tree tree_conc =
appl(prod(label("concrete",sort("Pattern")),[label("concrete",lex("Concrete"))],{}),[appl(prod(label("parsed",lex("Concrete")),[sort("EXP")],{}),[appl(prod(label("addition",sort("EXP")),[label("lhs",sort("EXP")),layouts("LAYOUTLIST"),lit("+"),layouts("LAYOUTLIST"),label("rhs",conditional(sort("EXP"),{except("match"),except("noMatch")}))],{\assoc(\Associativity::\left())}),[appl(prod(label("$MetaHole",sort("EXP")),[sort("ConcreteHole")],{Attr::\tag("holeType"(sort("EXP")))}),[appl(prod(label("one",sort("ConcreteHole")),[lit("\<"),layouts("LAYOUTLIST"),label("symbol",sort("Sym")),layouts("LAYOUTLIST"),label("name",lex("Name")),layouts("LAYOUTLIST"),lit("\>")],{}),[appl(prod(lit("\<"),[\char-class([range(60,60)])],{}),[char(60)]),appl(prod(layouts("LAYOUTLIST"),[conditional(\iter-star(lex("LAYOUT")),{\not-follow(\char-class([range(9,13),range(32,32),range(133,133),range(160,160),range(5760,5760),range(6158,6158),range(8192,8202),range(8232,8233),range(8239,8239),range(8287,8287),range(12288,12288)])),\not-follow(lit("//")),\not-follow(lit("/*"))})],{}),[appl(regular(\iter-star(lex("LAYOUT"))),[]
)]),appl(prod(label("nonterminal",sort("Sym")),[conditional(label("nonterminal",lex("Nonterminal")),{\not-follow(lit("["))})],{}),[appl(prod(lex("Nonterminal"),[conditional(seq([conditional(\char-class([range(65,90)]),{\not-precede(\char-class([range(65,90)]))}),conditional(\iter-star(\char-class([range(48,57),range(65,90),range(95,95),range(97,122)])),{\not-follow(\char-class([range(48,57),range(65,90),range(95,95),range(97,122)]))})]),{delete(keywords("RascalKeywords"))})],{}),[appl(regular(seq([conditional(\char-class([range(65,90)]),{\not-precede(\char-class([range(65,90)]))}),conditional(\iter-star(\char-class([range(48,57),range(65,90),range(95,95),range(97,122)])),{\not-follow(\char-class([range(48,57),range(65,90),range(95,95),range(97,122)]))})])),[char(69),appl(regular(\iter-star(\char-class([range(48,57),range(65,90),range(95,95),range(97,122)]))),[char(120),char(112),char(114),char(101),char(115),char(115),char(105),char(111),char(110)]
)])])]),appl(prod(layouts("LAYOUTLIST"),[conditional(\iter-star(lex("LAYOUT")),{\not-follow(\char-class([range(9,13),range(32,32),range(133,133),range(160,160),range(5760,5760),range(6158,6158),range(8192,8202),range(8232,8233),range(8239,8239),range(8287,8287),range(12288,12288)])),\not-follow(lit("//")),\not-follow(lit("/*"))})],{}),[appl(regular(\iter-star(lex("LAYOUT"))),[appl(prod(lex("LAYOUT"),[\char-class([range(9,13),range(32,32),range(133,133),range(160,160),range(5760,5760),range(6158,6158),range(8192,8202),range(8232,8233),range(8239,8239),range(8287,8287),range(12288,12288)])],{}),[char(32)]
)])]),appl(prod(lex("Name"),[conditional(seq([conditional(\char-class([range(65,90),range(95,95),range(97,122)]),{\not-precede(\char-class([range(65,90),range(95,95),range(97,122)]))}),conditional(\iter-star(\char-class([range(48,57),range(65,90),range(95,95),range(97,122)])),{\not-follow(\char-class([range(48,57),range(65,90),range(95,95),range(97,122)]))})]),{delete(keywords("RascalKeywords"))})],{}),[appl(regular(seq([conditional(\char-class([range(65,90),range(95,95),range(97,122)]),{\not-precede(\char-class([range(65,90),range(95,95),range(97,122)]))}),conditional(\iter-star(\char-class([range(48,57),range(65,90),range(95,95),range(97,122)])),{\not-follow(\char-class([range(48,57),range(65,90),range(95,95),range(97,122)]))})])),[char(95),appl(regular(\iter-star(\char-class([range(48,57),range(65,90),range(95,95),range(97,122)]))),[]
)])]),appl(prod(layouts("LAYOUTLIST"),[conditional(\iter-star(lex("LAYOUT")),{\not-follow(\char-class([range(9,13),range(32,32),range(133,133),range(160,160),range(5760,5760),range(6158,6158),range(8192,8202),range(8232,8233),range(8239,8239),range(8287,8287),range(12288,12288)])),\not-follow(lit("//")),\not-follow(lit("/*"))})],{}),[appl(regular(\iter-star(lex("LAYOUT"))),[]
)]),appl(prod(lit("\>"),[\char-class([range(62,62)])],{}),[char(62)])])]
),appl(prod(layouts("LAYOUTLIST"),[conditional(\iter-star(lex("LAYOUT")),{\not-follow(\char-class([range(9,13),range(32,32),range(133,133),range(160,160),range(5760,5760),range(6158,6158),range(8192,8202),range(8232,8233),range(8239,8239),range(8287,8287),range(12288,12288)])),\not-follow(lit("//")),\not-follow(lit("/*"))})],{}),[appl(regular(\iter-star(lex("LAYOUT"))),[appl(prod(lex("LAYOUT"),[\char-class([range(9,13),range(32,32),range(133,133),range(160,160),range(5760,5760),range(6158,6158),range(8192,8202),range(8232,8233),range(8239,8239),range(8287,8287),range(12288,12288)])],{}),[char(32)]
)])]),appl(prod(lit("+"),[\char-class([range(43,43)])],{}),[char(43)]),appl(prod(layouts("LAYOUTLIST"),[conditional(\iter-star(lex("LAYOUT")),{\not-follow(\char-class([range(9,13),range(32,32),range(133,133),range(160,160),range(5760,5760),range(6158,6158),range(8192,8202),range(8232,8233),range(8239,8239),range(8287,8287),range(12288,12288)])),\not-follow(lit("//")),\not-follow(lit("/*"))})],{}),[appl(regular(\iter-star(lex("LAYOUT"))),[appl(prod(lex("LAYOUT"),[\char-class([range(9,13),range(32,32),range(133,133),range(160,160),range(5760,5760),range(6158,6158),range(8192,8202),range(8232,8233),range(8239,8239),range(8287,8287),range(12288,12288)])],{}),[char(32)]
)])]),appl(prod(label("$MetaHole",sort("EXP")),[sort("ConcreteHole")],{Attr::\tag("holeType"(sort("EXP")))}),[appl(prod(label("one",sort("ConcreteHole")),[lit("\<"),layouts("LAYOUTLIST"),label("symbol",sort("Sym")),layouts("LAYOUTLIST"),label("name",lex("Name")),layouts("LAYOUTLIST"),lit("\>")],{}),[appl(prod(lit("\<"),[\char-class([range(60,60)])],{}),[char(60)]),appl(prod(layouts("LAYOUTLIST"),[conditional(\iter-star(lex("LAYOUT")),{\not-follow(\char-class([range(9,13),range(32,32),range(133,133),range(160,160),range(5760,5760),range(6158,6158),range(8192,8202),range(8232,8233),range(8239,8239),range(8287,8287),range(12288,12288)])),\not-follow(lit("//")),\not-follow(lit("/*"))})],{}),[appl(regular(\iter-star(lex("LAYOUT"))),[]
)]),appl(prod(label("nonterminal",sort("Sym")),[conditional(label("nonterminal",lex("Nonterminal")),{\not-follow(lit("["))})],{}),[appl(prod(lex("Nonterminal"),[conditional(seq([conditional(\char-class([range(65,90)]),{\not-precede(\char-class([range(65,90)]))}),conditional(\iter-star(\char-class([range(48,57),range(65,90),range(95,95),range(97,122)])),{\not-follow(\char-class([range(48,57),range(65,90),range(95,95),range(97,122)]))})]),{delete(keywords("RascalKeywords"))})],{}),[appl(regular(seq([conditional(\char-class([range(65,90)]),{\not-precede(\char-class([range(65,90)]))}),conditional(\iter-star(\char-class([range(48,57),range(65,90),range(95,95),range(97,122)])),{\not-follow(\char-class([range(48,57),range(65,90),range(95,95),range(97,122)]))})])),[char(69),appl(regular(\iter-star(\char-class([range(48,57),range(65,90),range(95,95),range(97,122)]))),[char(120),char(112),char(114),char(101),char(115),char(115),char(105),char(111),char(110)]
)])])]),appl(prod(layouts("LAYOUTLIST"),[conditional(\iter-star(lex("LAYOUT")),{\not-follow(\char-class([range(9,13),range(32,32),range(133,133),range(160,160),range(5760,5760),range(6158,6158),range(8192,8202),range(8232,8233),range(8239,8239),range(8287,8287),range(12288,12288)])),\not-follow(lit("//")),\not-follow(lit("/*"))})],{}),[appl(regular(\iter-star(lex("LAYOUT"))),[appl(prod(lex("LAYOUT"),[\char-class([range(9,13),range(32,32),range(133,133),range(160,160),range(5760,5760),range(6158,6158),range(8192,8202),range(8232,8233),range(8239,8239),range(8287,8287),range(12288,12288)])],{}),[char(32)]
)])]),appl(prod(lex("Name"),[conditional(seq([conditional(\char-class([range(65,90),range(95,95),range(97,122)]),{\not-precede(\char-class([range(65,90),range(95,95),range(97,122)]))}),conditional(\iter-star(\char-class([range(48,57),range(65,90),range(95,95),range(97,122)])),{\not-follow(\char-class([range(48,57),range(65,90),range(95,95),range(97,122)]))})]),{delete(keywords("RascalKeywords"))})],{}),[appl(regular(seq([conditional(\char-class([range(65,90),range(95,95),range(97,122)]),{\not-precede(\char-class([range(65,90),range(95,95),range(97,122)]))}),conditional(\iter-star(\char-class([range(48,57),range(65,90),range(95,95),range(97,122)])),{\not-follow(\char-class([range(48,57),range(65,90),range(95,95),range(97,122)]))})])),[char(95),appl(regular(\iter-star(\char-class([range(48,57),range(65,90),range(95,95),range(97,122)]))),[]
)])]),appl(prod(layouts("LAYOUTLIST"),[conditional(\iter-star(lex("LAYOUT")),{\not-follow(\char-class([range(9,13),range(32,32),range(133,133),range(160,160),range(5760,5760),range(6158,6158),range(8192,8202),range(8232,8233),range(8239,8239),range(8287,8287),range(12288,12288)])),\not-follow(lit("//")),\not-follow(lit("/*"))})],{}),[appl(regular(\iter-star(lex("LAYOUT"))),[]
)]),appl(prod(lit("\>"),[\char-class([range(62,62)])],{}),[char(62)])]
)])]
)])])
;

list[Symbol] getHoleTypes(appl(prod(label("concrete",sort("Pattern")),[label("concrete",lex("Concrete"))], {}),[Tree concrete1])){
    list[Symbol] holes = [];
    if(appl(prod(Symbol::label("parsed",Symbol::lex("Concrete")), [_],_),[Tree concrete2]) := concrete1){
        for(/appl(prod(Symbol::label("$MetaHole", Symbol _),[Symbol::sort("ConcreteHole")], {\tag("holeType"(Symbol holeType))}), [ConcreteHole _]) := concrete2){
            holes += holeType;
        }
    }
    return holes;
} 

test bool getHoleTypesInConcretePattern()  = getHoleTypes(tree_conc) == [ sort("EXP"), sort("EXP") ];